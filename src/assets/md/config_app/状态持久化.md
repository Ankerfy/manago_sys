在 Pinia 中实现**状态持久化**（即刷新页面后状态不丢失），最常用的方式是使用官方推荐的插件：**`pinia-plugin-persistedstate`**。

下面我将为你提供**完整、详细、可直接运行**的实现步骤。

---

## ✅ 一、安装插件

```bash
# npm
npm install pinia-plugin-persistedstate

# yarn
yarn add pinia-plugin-persistedstate

# pnpm
pnpm add pinia-plugin-persistedstate
```

> ✅ 该插件支持 `localStorage`、`sessionStorage`，也支持自定义存储（如 IndexedDB）。

---

## ✅ 二、在 Pinia 实例中注册插件

### 文件路径：`src/stores/index.js`（或你创建 Pinia 的地方）

```js
// src/stores/index.js
import { createPinia } from 'pinia'
import piniaPluginPersistedstate from 'pinia-plugin-persistedstate'

const pinia = createPinia()
pinia.use(piniaPluginPersistedstate)

export default pinia
```

### 如果你是在 `main.js` 中创建 Pinia

```js
// src/main.js
import { createApp } from 'vue'
import App from './App.vue'
import { createPinia } from 'pinia'
import piniaPluginPersistedstate from 'pinia-plugin-persistedstate'

const pinia = createPinia()
pinia.use(piniaPluginPersistedstate)

createApp(App).use(pinia).mount('#app')
```

---

## ✅ 三、在 Store 中启用持久化

### 示例：`src/stores/app.js`

```js
// src/stores/app.js
import { defineStore } from 'pinia'

export const useAppStore = defineStore('app', {
  state: () => ({
    isSidebarCollapse: false,
    theme: 'light',
    language: 'zh-CN',
  }),

  // ✅ 启用持久化
  persist: true,
})
```

> ✅ 只需添加 `persist: true`，该 store 的**整个 state** 就会自动保存到 `localStorage`。

---

## ✅ 四、高级配置（可选）

你可以对持久化行为进行细粒度控制：

```js
export const useAppStore = defineStore('app', {
  state: () => ({
    isSidebarCollapse: false,
    theme: 'light',
    language: 'zh-CN',
    tempData: '不会被保存', // 假设这个字段不想持久化
  }),

  persist: {
    // 存储键名（默认是 store 的 id，即 'app'）
    key: 'my-app-store',

    // 存储位置：'localStorage' | 'sessionStorage'
    storage: localStorage,

    // 指定要持久化的字段（白名单）
    paths: ['isSidebarCollapse', 'theme', 'language'],

    // 自定义序列化/反序列化（例如处理 Date 对象）
    // serializer: {
    //   serialize: JSON.stringify,
    //   deserialize: JSON.parse
    // }
  },
})
```

---

## ✅ 五、验证是否生效

1. 打开浏览器开发者工具 → Application → Local Storage
2. 查看是否有 `app` 或你指定的 `key`（如 `my-app-store`）
3. 修改状态（如折叠侧边栏）
4. 刷新页面，状态应保持不变

---

## ✅ 六、注意事项

| 问题                                  | 说明                                                                              |
| ------------------------------------- | --------------------------------------------------------------------------------- |
| **不能持久化函数、Symbol、undefined** | 只能持久化 JSON 兼容的数据（string, number, boolean, array, plain object）        |
| **响应式丢失？**                      | 插件会自动将数据反序列化并赋值给 state，保持响应式                                |
| **多个 store**                        | 每个 store 可独立配置 `persist`                                                   |
| **清除缓存**                          | 调用 `store.$reset()` 不会清除持久化数据，需手动 `localStorage.removeItem('key')` |

---

## ✅ 七、完整示例：侧边栏折叠状态持久化

### `src/stores/app.js`

```js
import { defineStore } from 'pinia'

export const useAppStore = defineStore('app', {
  state: () => ({
    isSidebarCollapse: false,
  }),
  persist: true,
})
```

### 在组件中使用

```vue
<script setup>
import { useAppStore } from '@/stores/app'
import { storeToRefs } from 'pinia'

const appStore = useAppStore()
const { isSidebarCollapse } = storeToRefs(appStore)

function toggleSidebar() {
  appStore.isSidebarCollapse = !appStore.isSidebarCollapse
}
</script>

<template>
  <button @click="toggleSidebar">Toggle Sidebar</button>
</template>
```

> ✅ 刷新页面后，`isSidebarCollapse` 的值会保持不变。

---

## ✅ 八、替代方案（不推荐）

如果你不想用插件，也可以手动监听 `watch` + `localStorage`，但代码繁琐且容易出错：

```js
// ❌ 不推荐的手动方式
watch(
  () => appStore.isSidebarCollapse,
  (val) => {
    localStorage.setItem('sidebarCollapse', JSON.stringify(val))
  },
)

// 初始化时读取
appStore.isSidebarCollapse = JSON.parse(localStorage.getItem('sidebarCollapse') || 'false')
```

> ✅ **强烈建议使用 `pinia-plugin-persistedstate`**，简洁、可靠、官方推荐。
