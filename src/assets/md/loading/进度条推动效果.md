è¿™æ˜¯ä¸€ä¸ªéå¸¸é«˜çº§ä¸”å…·æœ‰è®¾è®¡æ„Ÿçš„åŠ¨ç”»éœ€æ±‚ï¼

è‹¥å¸Œæœ›å®ç° **â€œé¡¶éƒ¨è¿›åº¦æ¡å¸¦æœ‰åœé¡¿æ•ˆæœâ€**ï¼Œå¦‚ï¼š

> **æ…¢ â†’ åœ â†’ åŠ è½½ â†’ åœ â†’ åŠ è½½ â†’ å¿«**

è¿™ç§è¡Œä¸º**ä¸ç¬¦åˆ NProgress é»˜è®¤çš„è‡ªåŠ¨æ¨è¿›é€»è¾‘**ï¼ˆå®ƒå€¾å‘äºå¹³æ»‘è¿ç»­ï¼‰ï¼Œä½†å¯ä»¥**é€šè¿‡æ‰‹åŠ¨æ§åˆ¶è¿›åº¦**æ¥å®ç°æ›´ç²¾ç»†ã€æ‹ŸäººåŒ–çš„åŠ è½½ä½“éªŒã€‚

---

#### âœ… ç›®æ ‡æ•ˆæœæ‹†è§£

æ¨¡æ‹Ÿä¸€ç§â€œæ™ºèƒ½åŠ è½½â€çš„æ„Ÿè§‰ï¼Œåƒæ˜¯ç³»ç»Ÿåœ¨æ€è€ƒã€ç­‰å¾…ã€å†æ¨è¿›ï¼š

```plain
[â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 10%  â†’ æ…¢æ…¢å¼€å§‹
[â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 10%  â†’ åœé¡¿ï¼ˆå‡è£…æ€è€ƒï¼‰
[â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 40%  â†’ çªç„¶åŠ è½½ä¸€éƒ¨åˆ†
[â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 40%  â†’ å†æ¬¡åœé¡¿
[â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 100% â†’ å¿«é€Ÿå®Œæˆ
```

---

#### âœ… å®ç°åŸç†

ğŸ‘‰ æ‰‹åŠ¨æ§åˆ¶NProgressæ¨è¿›æ•ˆæœï¼Œ**æ”¾å¼ƒè‡ªåŠ¨æ¨¡å¼**ï¼Œæ”¹ç”¨ `set()` æ‰‹åŠ¨æ§åˆ¶æ¯ä¸€æ­¥ï¼š

| æ–¹æ³•                | ä½œç”¨                              |
| ------------------- | --------------------------------- |
| `NProgress.start()` | å¼€å§‹ï¼ˆè‡ªåŠ¨ä» 0 åˆ° 90%ï¼‰           |
| `NProgress.set(n)`  | æ‰‹åŠ¨è®¾ç½®è¿›åº¦ï¼ˆ`n` æ˜¯ 0~1 çš„æ•°å€¼ï¼‰ |
| `NProgress.inc()`   | å¢åŠ ä¸€ä¸ªéšæœºå°è¿›åº¦                |
| `NProgress.done()`  | å®Œæˆï¼ˆè·³åˆ° 100% å¹¶éšè—ï¼‰          |

---

#### âœ… å®ç°æ­¥éª¤

**1. ç¦ç”¨è‡ªåŠ¨ trickleï¼Œæ”¹ä¸ºæ‰‹åŠ¨æ§åˆ¶**

```js
// src/router/index.js æˆ–ç»„ä»¶ä¸­  å…³é—­è‡ªåŠ¨æ¨è¿›
import NProgress from 'nprogress'

NProgress.configure({
  trickle: false, // å…³é—­è‡ªåŠ¨ç»†æµ
  showSpinner: false, // å¯é€‰ï¼šéšè— spinner
  easing: 'ease-out', // æ¨èä½¿ç”¨ ease-outï¼Œæ”¶å°¾æ›´è‡ªç„¶
  speed: 2000, // åŠ¨ç”»é€Ÿåº¦
})
```

**2. æ‰‹åŠ¨å®ç°â€œæ…¢-åœ-åŠ è½½-åœ-åŠ è½½-å¿«â€åŠ¨ç”»**

---

> **æ³¨æ„ï¼š**
> åŸæœ‰çš„ **stagedProgress.js** å·¥å…·ä¼˜åŒ– **Vue 3 ç°ä»£åŒ–å†™æ³•**ï¼Œä½¿ç”¨ **ES6 ç®­å¤´å‡½æ•°** å’Œæ›´ç¬¦åˆç°ä»£ JavaScript æ¨¡å—é£æ ¼çš„å®ç°æ–¹å¼ï¼š

#### âœ… ä¼˜åŒ–ç‚¹ï¼ˆ<span style="color: red;">ç°ä»£åŒ–å†™æ³• + ES6 ç®­å¤´å‡½æ•°</span>ï¼‰

> - 1ã€ä½¿ç”¨ const å£°æ˜ç®­å¤´å‡½æ•°
> - 2ã€ç§»é™¤äº†å¯å˜å˜é‡ï¼ˆå¦‚ indexï¼‰å’Œå‰¯ä½œç”¨ï¼Œæ”¹ç”¨é€’å½’ + Promise é“¾å¼è°ƒç”¨
> - 3ã€æ›´å¥½çš„é”™è¯¯å¤„ç†ä¸è¾¹ç•Œåˆ¤æ–­
> - 4ã€åˆ©ç”¨ç«‹å³æ‰§è¡Œå¼‚æ­¥å‡½æ•°å°è£…é€»è¾‘ï¼Œä½¿ä»£ç æ›´æ¸…æ™°
> - 5ã€æ”¯æŒåœ¨ Vue 3 çš„ setup æˆ–ç»„åˆå¼ API ä¸­ç›´æ¥å¯¼å…¥ä½¿ç”¨

#### âœ… ä¼˜åŒ–åçš„ä»£ç ï¼š`@/utils/stagedProgress.js`

```js
// @/utils/stagedProgress.js
import NProgress from 'nprogress'
import 'nprogress/nprogress.css'

// é…ç½® NProgress
NProgress.configure({
  trickle: false,
  showSpinner: false,
  easing: 'ease-out',
  speed: 2000,
})
let timeoutId = null
/**
 * æ‰‹åŠ¨åˆ†é˜¶æ®µè¿›åº¦æ¡
 * @param {Array<{ value: number, delay: number }>} stages - è¿›åº¦é˜¶æ®µæ•°ç»„
 * @returns {Promise<void>}
 */
export const startProgress = (stages) => {
  return new Promise((resolve) => {
    // æ¸…ç†ä¸Šä¸€ä¸ªå®šæ—¶å™¨
    if (timeoutId) {
      clearTimeout(timeoutId)
      timeoutId = null
    }

    // è¾¹ç•Œæ£€æŸ¥
    if (!Array.isArray(stages) || stages.length === 0) {
      NProgress.done()
      resolve()
      return
    }

    NProgress.start()
    const firstStage = stages[0]
    NProgress.set(firstStage?.value ?? 0.1) // è®¾ç½®åˆå§‹è¿›åº¦

    // é€’å½’é˜¶æ®µæ¨è¿›
    const proceedToNext = (index) => {
      if (index >= stages.length) {
        NProgress.done()
        resolve()
        return
      }
      const stage = stages[index]
      NProgress.set(stage.value)
      timeoutId = setTimeout(() => proceedToNext(index + 1), stage.delay)
    }
    timeoutId = setTimeout(() => proceedToNext(1), firstStage?.delay ?? 300)
  })
}
//ç«‹å³ç»“æŸè¿›åº¦æ¡ï¼ˆç”¨äºå¼‚å¸¸ã€è·³è½¬æˆ–ä¸­æ–­ï¼‰
export const endProgress = () => {
  if (timeoutId) {
    clearTimeout(timeoutId)
    timeoutId = null
  }
  NProgress.done()
}
```

---

#### âœ… åœ¨ Vue 3 è·¯ç”±å®ˆå«ä¸­ä½¿ç”¨ç¤ºä¾‹ï¼ˆ`router/index.js`ï¼‰

```js
// @/router/index.js
import { createRouter, createWebHistory } from 'vue-router'
import { startProgress as start, endProgress as end } from '@/utils/stagedProgress'

const router = createRouter({
  history: createWebHistory(),
  routes: [...],
})

// è·¯ç”±å‰ç½®å®ˆå«
router.beforeEach(async (to, from, next) => {
  // å®šä¹‰è¿›åº¦é˜¶æ®µ
  const PROGRESS_STAGES = [
    { value: 0.1, delay: 200 },
    { value: 0.1, delay: 500 }, // åœé¡¿
    { value: 0.4, delay: 300 },
    { value: 0.4, delay: 400 }, // åœé¡¿
    { value: 0.8, delay: 200 },
    { value: 1.0, delay: 100 },
  ]

  try {
    end()// æ¸…ç©ºä¸Šä¸€ä¸ªè¿›åº¦
    await start(PROGRESS_STAGES)
    next()
  } catch (error) {
    next()
  }
})

// è·¯ç”±åç½®é’©å­ï¼ˆå¯é€‰ï¼‰
router.afterEach(() => {
})
// è‹¥æœ‰å¼‚å¸¸éœ€æå‰ç»ˆæ­¢
router.onError(() => {
  end()
})

export default router
```

---

#### âœ… å°è£…ç›®æ ‡ï¼ˆ<span style="color: red;">ç»„åˆå¼å‡½æ•°</span> è®¾è®¡åŸåˆ™ï¼‰

> - 1ã€åªåœ¨ç»„ä»¶ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ï¼ˆå¦‚ `<script setup>`ï¼‰
> - 2ã€ä¸ä¾èµ–è·¯ç”±æˆ–å…¨å±€çŠ¶æ€
> - 3ã€å¯ç‹¬ç«‹æ§åˆ¶å¤šä¸ªè¿›åº¦åœºæ™¯ï¼ˆæ¯”å¦‚ï¼šé¡µé¢åŠ è½½ã€æŒ‰é’®æäº¤ç­‰ï¼‰
> - 4ã€æ”¯æŒæ‰‹åŠ¨è§¦å‘ã€è‡ªåŠ¨ç»“æŸã€å¼‚å¸¸å¤„ç†
> - 5ã€è¿”å›å“åº”å¼çŠ¶æ€ + æ§åˆ¶æ–¹æ³•

#### âœ… å°è£…ä»£ç ï¼š`@/composables/useProgress.js`

```js
// @/composables/useProgress.js
import { ref } from 'vue'
import { startProgress, endProgress } from '@/utils/stagedProgress'

/**
 * Vue 3 ç»„åˆå¼å‡½æ•°ï¼šç”¨äºæ§åˆ¶ NProgress è¿›åº¦æ¡ï¼Œæä¾›å“åº”å¼çŠ¶æ€å’Œä¾¿æ·æ–¹æ³•
 */
export function useProgress() {
  const isLoading = ref(false) // å“åº”å¼çŠ¶æ€ï¼šæ˜¯å¦æ­£åœ¨åŠ è½½

  /**
   * å¯åŠ¨åˆ†é˜¶æ®µè¿›åº¦æ¡
   * @param {Array<{ value: number, delay: number }>} stages - è¿›åº¦é˜¶æ®µé…ç½®
   * @returns {Promise<void>}
   */
  const start = async (
    stages = [
      { value: 0.1, delay: 300 },
      { value: 0.4, delay: 400 },
      { value: 0.7, delay: 600 },
      { value: 0.95, delay: 800 },
    ],
  ) => {
    isLoading.value = true
    try {
      await startProgress(stages)
    } finally {
      isLoading.value = false // ç¡®ä¿æ— è®ºæˆåŠŸæˆ–å¤±è´¥éƒ½æ›´æ–°çŠ¶æ€
    }
  }

  // ç«‹å³ç»“æŸè¿›åº¦æ¡ï¼ˆç”¨äºå¼‚å¸¸ã€ä¸­æ–­ç­‰åœºæ™¯ï¼‰
  const finish = () => {
    endProgress()
    isLoading.value = false
  }

  return {
    isLoading,
    start,
    finish,
  }
}
```

---

#### âœ… ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

##### åœºæ™¯ 1ï¼šæ™®é€šæŒ‰é’®ç‚¹å‡»åŠ è½½

```vue
<!-- SubmitButton.vue -->
<script setup>
import { useProgress } from '@/composables/useProgress'

const { isLoading, start, finish } = useProgress()

const handleSubmit = async () => {
  try {
    await start([
      { value: 0.2, delay: 200 },
      { value: 0.6, delay: 300 },
      { value: 0.9, delay: 500 },
    ])

    // æ¨¡æ‹ŸçœŸå®è¯·æ±‚
    await new Promise((resolve) => setTimeout(resolve, 1000))
    alert('æäº¤æˆåŠŸï¼')
  } catch (err) {
    finish() // å‡ºé”™æ—¶æ‰‹åŠ¨ç»ˆæ­¢
  }
}
</script>

<template>
  <button @click="handleSubmit" :disabled="isLoading">
    {{ isLoading ? 'æäº¤ä¸­...' : 'æäº¤' }}
  </button>
</template>
```

---

##### åœºæ™¯ 2ï¼šé…åˆ Axios è¯·æ±‚æ‹¦æˆªå™¨ï¼ˆé«˜çº§ç”¨æ³•ï¼‰

å¦‚æœä½ å¸Œæœ›**æ‰€æœ‰è¯·æ±‚è‡ªåŠ¨è§¦å‘è¿›åº¦æ¡**ï¼Œå¯ä»¥åœ¨ `api/interceptor.js` ä¸­ä½¿ç”¨åº•å±‚å·¥å…·ï¼š

```js
// @/utils/request.js
import axios from 'axios'
import { startProgress as start, endProgress as end } from '@/utils/stagedProgress'

const service = axios.create({ baseURL: '/api' })

service.interceptors.request.use(async (config) => {
  await start([
    { value: 0.1, delay: 200 },
    { value: 0.4, delay: 300 },
    { value: 0.7, delay: 500 },
  ])
  return config
})

service.interceptors.response.use(
  (response) => {
    end()
    return response
  },
  (error) => {
    end()
    return Promise.reject(error)
  },
)

export default service
```

> ğŸ”” æ³¨æ„ï¼šè¿™é‡Œä¾ç„¶ä¸èƒ½ç”¨ `useProgress()`ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨ `startProgress` å’Œ `endProgress`

---

#### âœ… æ˜¯å¦æ”¯æŒå¤šä¸ªè¿›åº¦æ¡åŒæ—¶è¿è¡Œï¼Ÿ

âœ… æ”¯æŒï¼å› ä¸ºæ¯æ¬¡è°ƒç”¨ `useProgress()` éƒ½ä¼šåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ `isLoading` å®ä¾‹ã€‚

```vue
<!-- å¯ä»¥æœ‰ä¸¤ä¸ªç‹¬ç«‹çš„æŒ‰é’®æ§åˆ¶å„è‡ªçš„åŠ è½½çŠ¶æ€ -->
<template>
  <button @click="loadDataA" :disabled="progressA.isLoading">åŠ è½½ A</button>
  <button @click="loadDataB" :disabled="progressB.isLoading">åŠ è½½ B</button>
</template>

<script setup>
import { useProgress } from '@/composables/useProgress'

const progressA = useProgress()
const progressB = useProgress()

const loadDataA = () =>
  progressA.start([
    { value: 0.5, delay: 500 },
    { value: 1, delay: 100 },
  ])
const loadDataB = () =>
  progressB.start([
    { value: 0.3, delay: 300 },
    { value: 1, delay: 200 },
  ])
</script>
```

---

#### â“ æ ¸å¿ƒé—®é¢˜

> è·¯ç”±é…ç½®æ–‡ä»¶ `router/index.js` ä¸­èƒ½ä¸èƒ½ç›´æ¥ä½¿ç”¨ `useProgress()`ï¼ˆå³ Composition APIï¼‰ï¼Ÿ

#### âœ… ç»“è®º

> ğŸš« `useProgress()` æ˜¯ä¸€ä¸ª **ç»„åˆå¼å‡½æ•°ï¼ˆComposableï¼‰**ï¼Œå®ƒä¾èµ–äº Vue çš„ **è¿è¡Œæ—¶ä¸Šä¸‹æ–‡ï¼ˆsetup contextï¼‰**ï¼Œåªèƒ½åœ¨ä»¥ä¸‹ä½ç½®å®‰å…¨è°ƒç”¨ï¼š
>
> - `setup()` å‡½æ•°
> - `<script setup>`
> - å…¶ä»–ç»„åˆå¼å‡½æ•°å†…éƒ¨
> - Pinia Store ä¸­ï¼ˆé€šè¿‡ `defineStore` åŒ…è£…ï¼‰
> - è€Œ `router/index.js` æ˜¯ä¸€ä¸ª **æ™®é€š JavaScript æ¨¡å—**ï¼Œåœ¨åº”ç”¨å¯åŠ¨æ—¶åŒæ­¥æ‰§è¡Œï¼Œ**æ­¤æ—¶ Vue å®ä¾‹è¿˜æœªåˆ›å»º**ï¼Œæ²¡æœ‰æ´»åŠ¨çš„ç»„ä»¶å®ä¾‹ä¸Šä¸‹æ–‡ï¼Œå› æ­¤ **ä¸èƒ½è°ƒç”¨ä»»ä½• `useXxx()` å‡½æ•°**ã€‚
>
> <hr/>

#### âœ… æ­£ç¡®åšæ³•ï¼šåˆ†å±‚è®¾è®¡

å§‹ç»ˆåšæŒ **â€œå·¥å…·é€»è¾‘â€ä¸â€œç»„åˆé€»è¾‘â€åˆ†ç¦»** çš„æ¶æ„åŸåˆ™ï¼š

| å±‚çº§                           | ç”¨é€”                        | å¯ç”¨ API                            |
| ------------------------------ | --------------------------- | ----------------------------------- |
| `@/utils/stagedProgress.js`    | å·¥å…·å±‚ï¼šçº¯å‡½æ•°ï¼Œæ— ä¾èµ–      | âœ… å¯åœ¨ä»»æ„ JS æ–‡ä»¶ä½¿ç”¨ï¼ˆåŒ…æ‹¬è·¯ç”±ï¼‰ |
| `@/composables/useProgress.js` | ç»„åˆå±‚ï¼šä¾èµ– Vue å“åº”å¼ç³»ç»Ÿ | âŒ ä»…é™ setup / ç»„ä»¶ / Store ä¸­ä½¿ç”¨ |

#### âœ… æ­£ç¡®ä½¿ç”¨æ–¹å¼ï¼ˆæ¨èï¼‰

##### 1. åœ¨è·¯ç”±ä¸­ï¼šä½¿ç”¨ `@/utils/stagedProgress.js`ï¼ˆâœ”ï¸ æ­£ç¡®ï¼‰

##### 2. åœ¨ç»„ä»¶ä¸­ï¼šä½¿ç”¨ `useProgress()`ï¼ˆâœ”ï¸ æ­£ç¡®ï¼‰

---

#### âœ… æ¶æ„å›¾ï¼šåˆ†å±‚æ¸…æ™°

```plain
+---------------------+
|   ç»„ä»¶ (.vue)       |  <-- ä½¿ç”¨ useProgress() âœ…
+----------+----------+
           |
           | è°ƒç”¨
           v
+---------------------+
|  ç»„åˆå¼å‡½æ•°          |  <-- useProgress.js (ä¾èµ– Vue)
|  useProgress()      |
+----------+----------+
           |
           | è°ƒç”¨
           v
+---------------------+
|  å·¥å…·å‡½æ•°            |  <-- stagedProgress.js (çº¯ JS)
|  start / end        |       å¯åœ¨ routerã€apiã€ä»»æ„åœ°æ–¹ä½¿ç”¨ âœ…
+---------------------+
```

---

#### âœ… æœ€ç»ˆç›®å½•ç»“æ„å»ºè®®

```md
src/
â”œâ”€â”€ router/
â”‚ â””â”€â”€ index.js
â”œâ”€â”€ utils/
â”‚ â””â”€â”€ stagedProgress.js # åˆ†é˜¶æ®µè¿›åº¦æ¡é€»è¾‘
â”œâ”€â”€ composables/
â”‚ â””â”€â”€ useProgress.js # ä¾›ç»„ä»¶ä½¿ç”¨çš„ Composition API ç‰ˆ
â””â”€â”€ views/

> - `utils/stagedProgress.js`ï¼šä¾›è·¯ç”±ã€æ’ä»¶ç­‰éç»„ä»¶ç¯å¢ƒä½¿ç”¨
> - `composables/useProgress.js`ï¼šä¾› `<script setup>` ç»„ä»¶ä½¿ç”¨
```

---

#### âœ… æ€»ç»“ï¼šå¦‚ä½•å®ç°â€œæ…¢-åœ-åŠ è½½-åœ-åŠ è½½-å¿«â€

| æ­¥éª¤            | æ–¹æ³•                                      |
| --------------- | ----------------------------------------- |
| 1. å…³é—­è‡ªåŠ¨æ¨è¿› | `NProgress.configure({ trickle: false })` |
| 2. æ‰‹åŠ¨è®¾ç½®è¿›åº¦ | `NProgress.set(0.2)`                      |
| 3. å®ç°åœé¡¿     | `setTimeout` æˆ– `await sleep()`           |
| 4. åˆ†é˜¶æ®µæ§åˆ¶   | ä½¿ç”¨æ•°ç»„ + å¾ªç¯æˆ–é€’å½’                     |
| 5. æœ€ç»ˆå®Œæˆ     | `NProgress.done()`                        |

âœ… **é€‚ç”¨åœºæ™¯**ï¼š

- å¯åŠ¨é¡µåŠ¨ç”»
- æ•°æ®åˆå§‹åŒ–æµç¨‹
- å“ç‰Œå±•ç¤ºå‹é¡µé¢
- éœ€è¦â€œæ‹ŸäººåŒ–â€åŠ è½½ä½“éªŒçš„äº§å“
